<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hệ Thống Quản Lý Kho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e9eff5; color: #343a40; padding-top: 0; }
        .navbar { margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        main { max-width: 800px; margin: auto; padding: 10px; }
        section { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: none; }
        section.active { display: block; }
        h2 { border-bottom: 2px solid #e0e6ea; padding-bottom: 12px; margin-bottom: 25px; }
        .nhap-title { color: #007bff; }
        .xuat-title { color: #dc3545; }
        .camera-area { width: 100%; max-width: 450px; margin: 20px auto; border: 3px solid #007bff; border-radius: 10px; overflow: hidden; display: none; }
        #camera-area-xh { border-color: #dc3545; }
        .table-nhap th { background-color: #007bff; color: white; }
        .table-xuat th { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-warehouse"></i> KHO HÀNG</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" data-section="nhaphang" href="#"><i class="fas fa-download"></i> Nhập hàng</a></li>
                    <li class="nav-item"><a class="nav-link" data-section="xuathang" href="#"><i class="fas fa-upload"></i> Xuất hàng</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container">
        <section id="nhaphang" class="active">
            <h2 class="nhap-title"><i class="fas fa-truck-loading"></i> Quản lý nhập hàng</h2>
            <form id="form-nhaphang">
                <input type="hidden" id="edit-id" value="">
                <div class="mb-3">
                    <label class="form-label">Barcode sản phẩm:</label>
                    <div class="input-group">
                        <input type="text" id="nh-barcode" class="form-control" placeholder="Quét mã..." autocomplete="off">
                        <button type="button" id="btn-mo-camera-nh" class="btn btn-info text-white"><i class="fas fa-qrcode"></i> Quét</button>
                    </div>
                    <div id="camera-area-nh" class="camera-area"></div>
                </div>
                <div id="nhap-thongtin-sp-nh" style="display:none;" class="mt-3 p-3 bg-info-subtle border border-info rounded">
                    <div class="mb-3"><label class="form-label">Tên SP:</label><input type="text" id="ten-sp-nh" class="form-control"></div>
                    <div class="mb-3">
                        <label class="form-label">Đơn vị quy đổi:</label>
                        <div class="d-flex gap-2">
                            <input type="text" id="dv-lon" class="form-control" placeholder="Thùng">
                            <input type="text" id="dv-nho" class="form-control" placeholder="12 chai">
                        </div>
                    </div>
                    <div class="mb-3"><label class="form-label">SL Lẻ:</label><input type="number" id="so-luong-le" class="form-control"></div>
                </div>
                <div class="mb-3"><label class="form-label">Số lượng thêm:</label><input type="number" id="nh-soluong" class="form-control" value="1"></div>
                
                <div class="d-grid gap-2">
                    <button type="submit" id="btn-submit" class="btn btn-primary btn-lg">Xác nhận & Cộng dồn</button>
                    <div class="btn-group">
                        <button type="button" id="btn-excel-nh" class="btn btn-success"><i class="fas fa-file-excel"></i> Xuất Excel Nhập</button>
                        <button type="button" onclick="clearAllNH()" class="btn btn-outline-danger btn-sm">Xóa hết nhập</button>
                    </div>
                </div>
            </form>
            <div class="table-responsive mt-4">
                <table id="table-nhaphang" class="table table-striped table-hover align-middle table-nhap">
                    <thead><tr><th>Barcode</th><th>Tên SP</th><th>Tồn Kho</th><th>Lẻ</th><th>Đơn vị</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="xuathang">
            <h2 class="xuat-title"><i class="fas fa-box-open"></i> Quản lý xuất hàng</h2>
            <form id="form-xuathang">
                <div class="mb-3">
                    <label class="form-label">Barcode xuất:</label>
                    <div class="input-group">
                        <input type="text" id="xh-barcode" class="form-control border-danger" placeholder="Quét mã...">
                        <button type="button" id="btn-mo-camera-xh" class="btn btn-danger"><i class="fas fa-qrcode"></i></button>
                    </div>
                    <div id="camera-area-xh" class="camera-area"></div>
                </div>
                <div id="nhap-thongtin-sp-xh" style="display:none;" class="mt-3 p-3 bg-danger-subtle border border-danger rounded">
                    <div class="mb-3"><label class="form-label">Tên SP:</label><input type="text" id="ten-sp-xh" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Số lượng lẻ:</label><input type="number" id="xh-so-luong-le" class="form-control"></div>
                </div>
                <div class="mb-3"><label class="form-label">Số lượng xuất:</label><input type="number" id="xh-soluong" class="form-control border-danger" value="1"></div>
                <button type="submit" class="btn btn-danger w-100">Đưa vào danh sách chờ xuất</button>
            </form>
            <div class="table-responsive mt-4">
                <table id="table-xuathang" class="table table-bordered align-middle table-xuat">
                    <thead><tr><th>Barcode</th><th>Tên SP</th><th>SL Xuất</th><th>Lẻ</th></tr></thead>
                    <tbody id="list-xuat-tam"></tbody>
                </table>
            </div>
            <div class="d-grid gap-2 mt-3">
                <button id="btn-luu-xuat-kho" class="btn btn-dark p-3 fw-bold"><i class="fas fa-save"></i> LƯU & TRỪ KHO</button>
                <button id="btn-excel-xh" class="btn btn-outline-success"><i class="fas fa-file-excel"></i> XUẤT EXCEL LỊCH SỬ XUẤT</button>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        // Điều hướng
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.getAttribute('data-section')).classList.add('active');
            });
        });

        // Dữ liệu
        let nhapHangList = JSON.parse(localStorage.getItem('nhapHangList')) || [];
        let lichSuXuat = JSON.parse(localStorage.getItem('lichSuXuat')) || [];
        let tempXuat = [];

        // Logic Barcode
        const setupBC = (input, info, ten) => {
            input.addEventListener('input', () => {
                const bc = input.value.trim();
                const sp = nhapHangList.find(s => s.barcode === bc);
                if (sp) { info.style.display = 'none'; ten.value = sp.ten; }
                else if (bc !== "") { info.style.display = 'block'; }
            });
        };
        setupBC(document.getElementById('nh-barcode'), document.getElementById('nhap-thongtin-sp-nh'), document.getElementById('ten-sp-nh'));
        setupBC(document.getElementById('xh-barcode'), document.getElementById('nhap-thongtin-sp-xh'), document.getElementById('ten-sp-xh'));

        // NHẬP HÀNG
        document.getElementById('form-nhaphang').onsubmit = (e) => {
            e.preventDefault();
            const bc = document.getElementById('nh-barcode').value.trim();
            const sl = parseInt(document.getElementById('nh-soluong').value);
            const ten = document.getElementById('ten-sp-nh').value;
            const le = document.getElementById('so-luong-le').value;
            const dv = `${document.getElementById('dv-lon').value}/${document.getElementById('dv-nho').value}`;

            let item = nhapHangList.find(i => i.barcode === bc);
            if (item) item.soluong += sl;
            else nhapHangList.push({ id: Date.now(), barcode: bc, ten, soluong: sl, soLuongLe: le, donvi: dv });
            
            saveData();
            e.target.reset();
            document.getElementById('nhap-thongtin-sp-nh').style.display = 'none';
        };

        // THÊM TẠM XUẤT
        document.getElementById('form-xuathang').onsubmit = (e) => {
            e.preventDefault();
            const bc = document.getElementById('xh-barcode').value.trim();
            const sl = parseInt(document.getElementById('xh-soluong').value);
            const ten = document.getElementById('ten-sp-xh').value;
            const le = document.getElementById('xh-so-luong-le').value || 0;

            let item = tempXuat.find(i => i.barcode === bc);
            if (item) item.sl += sl;
            else tempXuat.push({ barcode: bc, ten, sl, le });

            renderXuat();
            e.target.reset();
            document.getElementById('nhap-thongtin-sp-xh').style.display = 'none';
        };

        // LƯU XUẤT & TRỪ KHO
        document.getElementById('btn-luu-xuat-kho').onclick = () => {
            if (tempXuat.length === 0) return alert("Chưa có hàng trong danh sách xuất!");
            
            tempXuat.forEach(tx => {
                let inKho = nhapHangList.find(n => n.barcode === tx.barcode);
                if (inKho) inKho.soluong -= tx.sl;

                // Lưu vào lịch sử xuất thực tế
                let lichSu = lichSuXuat.find(l => l.barcode === tx.barcode);
                if (lichSu) lichSu.sl += tx.sl;
                else lichSuXuat.push({...tx, date: new Date().toLocaleString()});
            });

            localStorage.setItem('lichSuXuat', JSON.stringify(lichSuXuat));
            tempXuat = [];
            saveData();
            renderXuat();
            alert("Đã lưu và trừ kho thành công!");
        };

        function saveData() {
            localStorage.setItem('nhapHangList', JSON.stringify(nhapHangList));
            renderNH();
        }

        function renderNH() {
            document.querySelector('#table-nhaphang tbody').innerHTML = nhapHangList.map(i => `
                <tr><td>${i.barcode}</td><td>${i.ten}</td><td class="fw-bold text-primary">${i.soluong}</td><td>${i.soLuongLe || 0}</td><td>${i.donvi || ''}</td></tr>
            `).join('');
        }

        function renderXuat() {
            document.getElementById('list-xuat-tam').innerHTML = tempXuat.map(i => `
                <tr><td>${i.barcode}</td><td>${i.ten}</td><td class="text-danger fw-bold">${i.sl}</td><td>${i.le}</td></tr>
            `).join('');
        }

        // XUẤT EXCEL NHẬP (FILE CHUẨN)
        document.getElementById('btn-excel-nh').onclick = () => {
            const ws = XLSX.utils.json_to_sheet(nhapHangList.map(i => ({ "Barcode": i.barcode, "Tên SP": i.ten, "Tồn Kho": i.soluong, "Lẻ": i.soLuongLe, "Đơn vị": i.donvi })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "TonKho");
            XLSX.writeFile(wb, "Bao_Cao_Ton_Kho.xlsx");
        };

        // XUẤT EXCEL XUẤT
        document.getElementById('btn-excel-xh').onclick = () => {
            if (lichSuXuat.length === 0) return alert("Chưa có lịch sử xuất!");
            const ws = XLSX.utils.json_to_sheet(lichSuXuat.map(i => ({ "Barcode": i.barcode, "Tên SP": i.ten, "Số lượng xuất": i.sl, "Ngày xuất": i.date })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "LichSuXuat");
            XLSX.writeFile(wb, "Bao_Cao_Xuat_Hang.xlsx");
        };

        function clearAllNH() {
            if(confirm("Xóa toàn bộ tồn kho?")) { nhapHangList = []; saveData(); }
        }

        // Camera
        const cam = (btn, area, input) => {
            document.getElementById(btn).onclick = () => {
                const a = document.getElementById(area); a.style.display = 'block';
                const s = new Html5Qrcode(area);
                s.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (t) => {
                    document.getElementById(input).value = t;
                    document.getElementById(input).dispatchEvent(new Event('input'));
                    s.stop(); a.style.display = 'none';
                });
            };
        };
        cam('btn-mo-camera-nh', 'camera-area-nh', 'nh-barcode');
        cam('btn-mo-camera-xh', 'camera-area-xh', 'xh-barcode');

        renderNH();
    </script>
</body>
</html>
