<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>B√°n H√†ng By Quang dz (JSON N·ªëi Li·ªÅn)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* CSS t√πy ch·ªânh (Gi·ªØ nguy√™n) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e9eff5;
            color: #343a40;
        }

        .navbar {
            background-color: #17a2b8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            padding: 10px 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5em;
        }

        .navbar-nav .nav-link {
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            background-color: #138496;
            color: white;
        }

        main {
            padding: 25px 0;
        }

        section {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        h2, h3 {
            color: #007bff;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e6ea;
            padding-bottom: 12px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-control {
            border-radius: 6px;
            border: 1px solid #cdd4da;
            padding: 12px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
        }

        .btn {
            border-radius: 6px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .btn-primary { background-color: #007bff; border-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; border-color: #004085; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,.2); }
        .btn-success { background-color: #28a745; border-color: #28a745; }
        .btn-success:hover { background-color: #218838; border-color: #1e7e34; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,.2); }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; border-color: #bd2130; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,.2); }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; border-color: #117a8b; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,.2); }
        .btn-sm { padding: 6px 12px; font-size: 0.9em; border-radius: 5px; }

        table {
            margin-top: 25px;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 15px 18px;
            vertical-align: middle;
            border-top: 1px solid #e9ecef;
        }

        th {
            background-color: #007bff;
            color: white;
            text-align: left;
            font-weight: 700;
            border-bottom: 1px solid #0056b3;
        }

        tbody tr:nth-child(even) { background-color: #f6f8fa; }
        tbody tr:hover { background-color: #e9f5ff; cursor: pointer; }

        #thongtin-sp {
            margin-top: 15px; padding: 15px; background-color: #d4edda;
            border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;
            font-weight: bold; font-size: 1.05em;
        }

        #nhap-thongtin-sp {
            background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px;
            padding: 20px; margin-top: 20px; color: #856404;
        }

        #nhap-thongtin-sp-nh {
            background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px;
            padding: 20px; margin-top: 20px; color: #0c5460;
        }

        #tongtien {
            font-size: 2.2em; font-weight: bold; color: #dc3545;
            text-align: right; display: block; margin-top: 25px;
            padding-top: 15px; border-top: 1px dashed #ced4da;
        }

        #camera-area, #camera-area-sp, #camera-area-nh {
            width: 100%; max-width: 450px; margin: 20px auto;
            border: 3px solid #007bff; border-radius: 10px;
            overflow: hidden; background-color: #f8f9fa;
        }
        
        /* CSS cho ph·∫ßn nh·∫≠p JSON m·ªõi */
        #json-import-section {
            background-color: #f8f9fa;
            border: 2px dashed #17a2b8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 767px) {
            .navbar-brand { font-size: 1.2em; }
            .navbar-nav { flex-direction: column; align-items: flex-start; }
            .navbar-nav .nav-item { width: 100%; margin-bottom: 5px; }
            .navbar-nav .nav-link { text-align: center; margin: 5px 0; }
            .btn { width: 100%; margin-bottom: 10px; }
            .btn:last-child { margin-bottom: 0; }
            section { padding: 20px; }
            h2, h3 { font-size: 1.5em; margin-bottom: 15px; padding-bottom: 8px; }
            .form-control { padding: 10px; }
            .btn { padding: 10px 20px; }
            #tongtien { font-size: 1.8em; margin-top: 20px; padding-top: 10px; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">QU·∫¢N L√ù B√ÅN H√ÄNG</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" data-section="banhang" href="#"><i class="fas fa-cash-register"></i> B√°n h√†ng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="xemdon" href="#"><i class="fas fa-list-alt"></i> Xem ƒë∆°n</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="doanhthu" href="#"><i class="fas fa-chart-line"></i> Doanh thu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="phieu" href="#"><i class="fas fa-file-invoice"></i> Phi·∫øu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="sanpham" href="#"><i class="fas fa-box"></i> S·∫£n ph·∫©m</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="nhaphang" href="#"><i class="fas fa-truck-loading"></i> Nh·∫≠p h√†ng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="tonkho" href="#"><i class="fas fa-warehouse"></i> T·ªìn kho</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <main class="container mt-4">
        <section id="banhang" style="display: block;">
            <h2><i class="fas fa-cash-register"></i> B√°n h√†ng</h2>
            <form id="form-banhang">
                <div class="mb-3">
                    <label for="barcode" class="form-label">M√£ barcode:</label>
                    <input type="text" id="barcode" class="form-control" required autocomplete="off" placeholder="Nh·∫≠p barcode ho·∫∑c qu√©t" />
                    <button type="button" id="btn-mo-camera" class="btn btn-info mt-2"><i class="fas fa-qrcode"></i> Qu√©t barcode</button>
                    <div id="camera-area" style="width: 100%; max-width: 300px; margin-top: 10px; display:none;"></div>
                    <div id="thongtin-sp" class="mt-2"></div>
                    <div id="nhap-thongtin-sp" style="display:none;" class="mt-3 p-3 bg-warning-subtle border border-warning rounded">
                        <p class="mb-2 text-danger">S·∫£n ph·∫©m ch∆∞a c√≥ trong danh s√°ch. Vui l√≤ng nh·∫≠p th·ªß c√¥ng th√¥ng tin:</p>
                        <div class="mb-3">
                            <label for="ten-sp-thu-cong" class="form-label">T√™n s·∫£n ph·∫©m:</label>
                            <input type="text" id="ten-sp-thu-cong" class="form-control" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" />
                        </div>
                        <div class="mb-3">
                            <label for="gia-sp-thu-cong" class="form-label">Gi√° b√°n (VNƒê):</label>
                            <input type="number" id="gia-sp-thu-cong" class="form-control" placeholder="Nh·∫≠p gi√° b√°n" min="0" />
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="soluong" class="form-label">S·ªë l∆∞·ª£ng:</label>
                    <input type="number" id="soluong" class="form-control" value="1" min="1" required />
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Th√™m v√†o ƒë∆°n</button>
            </form>

            <h3 class="mt-4">ƒê∆°n h√†ng hi·ªán t·∫°i</h3>
            <div class="table-responsive">
                <table id="table-donhang" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Barcode</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√° b√°n</th>
                            <th>Th√†nh ti·ªÅn</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h3 class="mt-3">T·ªïng ti·ªÅn: <span id="tongtien">0</span> VNƒê</h3>
            <div class="d-grid gap-2 d-md-block mt-3">
                <button id="btn-luu-don" class="btn btn-success"><i class="fas fa-save"></i> L∆∞u ƒë∆°n h√†ng</button>
                <button id="btn-in-hoa-don" class="btn btn-info"><i class="fas fa-print"></i> In h√≥a ƒë∆°n</button>
            </div>
        </section>

        <section id="xemdon" style="display:none">
            <h2><i class="fas fa-list-alt"></i> Xem l·∫°i ƒë∆°n b√°n</h2>
            <div class="table-responsive">
                <table id="table-xemdon" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Ng√†y b√°n</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Chi ti·∫øt</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="doanhthu" style="display:none">
            <h2><i class="fas fa-chart-line"></i> Doanh thu & L·ª£i nhu·∫≠n</h2>
            <p><strong>T·ªïng doanh thu:</strong> <span id="tong-doanh-thu">0</span> VNƒê</p>
            <p><strong>L·ª£i nhu·∫≠n ∆∞·ªõc t√≠nh:</strong> <span id="loi-nhuan">0</span> VNƒê</p>
        </section>

        <section id="phieu" style="display:none">
            <h2><i class="fas fa-file-invoice"></i> Qu·∫£n l√Ω phi·∫øu</h2>
            <div class="table-responsive">
                <table id="table-phieu" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Ng√†y b√°n</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="sanpham" style="display:none">
            <h2><i class="fas fa-box"></i> Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>

            <div class="mb-4">
                <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#json-import-section" aria-expanded="false" aria-controls="json-import-section">
                    <i class="fas fa-file-import"></i> üì• Nh·∫≠p d·ªØ li·ªáu t·ª´ JSON (H·ªó tr·ª£ JSON n·ªëi li·ªÅn)
                </button>
            </div>
            
            <div class="collapse" id="json-import-section">
                <div class="mb-3">
                    <label for="json-input-data" class="form-label fw-bold">D√°n ƒëo·∫°n m√£ JSON v√†o ƒë√¢y:</label>
                    <textarea class="form-control" id="json-input-data" rows="5" placeholder='V√≠ d·ª•: [{"barcode":"8401...","ten":"T√™n SP","gia":100000}, ...] Ho·∫∑c d√°n li·ªÅn nhi·ªÅu m·∫£ng: [...][...]'></textarea>
                    <div class="form-text">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t n·∫øu barcode ƒë√£ t·ªìn t·∫°i.</div>
                </div>
                <button type="button" id="btn-process-json" class="btn btn-primary mb-3">L∆∞u v√†o h·ªá th·ªëng</button>
                <hr>
            </div>
            <form id="form-sanpham">
                <div class="mb-3">
                    <label for="sp-barcode" class="form-label">Barcode s·∫£n ph·∫©m:</label>
                    <input type="text" id="sp-barcode" class="form-control" autocomplete="off" placeholder="Nh·∫≠p barcode s·∫£n ph·∫©m" />
                    <button type="button" id="btn-mo-camera-sp" class="btn btn-info mt-2"><i class="fas fa-qrcode"></i> Qu√©t barcode</button>
                    <div id="camera-area-sp" style="width: 100%; max-width: 300px; margin-top: 10px; display:none;"></div>
                </div>
                <div class="mb-3">
                    <label for="sp-ten" class="form-label">T√™n s·∫£n ph·∫©m:</label>
                    <input type="text" id="sp-ten" class="form-control" required placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" />
                </div>
                <div class="mb-3">
                    <label for="sp-gia" class="form-label">Gi√° b√°n:</label>
                    <input type="number" id="sp-gia" class="form-control" min="0" required placeholder="Nh·∫≠p gi√° b√°n" />
                </div>
                <div class="d-grid gap-2 d-md-block">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus-square"></i> Th√™m/S·ª≠a s·∫£n ph·∫©m</button>
                    <button type="button" id="btn-xoa-sp" class="btn btn-danger" style="display: none;"><i class="fas fa-trash-alt"></i> X√≥a s·∫£n ph·∫©m</button>
                </div>
            </form>

            <h3 class="mt-4">Danh s√°ch s·∫£n ph·∫©m</h3>
            <div class="mb-3">
                <label for="sp-search" class="form-label">T√¨m ki·∫øm s·∫£n ph·∫©m:</label>
                <input type="text" id="sp-search" class="form-control" placeholder="T√¨m ki·∫øm theo barcode ho·∫∑c t√™n s·∫£n ph·∫©m" />
            </div>
            <div class="table-responsive">
                <table id="table-sanpham" class="table table-striped table-hover">
                    <thead>
                        <tr><th>Barcode</th><th>T√™n s·∫£n ph·∫©m</th><th>Gi√° b√°n</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="nhaphang" style="display:none">
            <h2><i class="fas fa-truck-loading"></i> Qu·∫£n l√Ω h√†ng nh·∫≠p</h2>
            <form id="form-nhaphang">
                <div class="mb-3">
                    <label for="nh-barcode" class="form-label">Barcode s·∫£n ph·∫©m:</label>
                    <input type="text" id="nh-barcode" class="form-control" autocomplete="off" placeholder="Nh·∫≠p barcode s·∫£n ph·∫©m" />
                    <button type="button" id="btn-mo-camera-nh" class="btn btn-info mt-2"><i class="fas fa-qrcode"></i> Qu√©t barcode</button>
                    <div id="camera-area-nh" style="width: 100%; max-width: 300px; margin-top: 10px; display:none;"></div>
                </div>

                <div id="nhap-thongtin-sp-nh" style="display:none;" class="mt-3 p-3 bg-info-subtle border border-info rounded">
                    <p class="mb-2 text-primary">Barcode ch∆∞a t·ªìn t·∫°i. Vui l√≤ng nh·∫≠p th√¥ng tin s·∫£n ph·∫©m m·ªõi:</p>
                    <div class="mb-3">
                        <label for="ten-sp-nh" class="form-label">T√™n s·∫£n ph·∫©m (th·ªß c√¥ng):</label>
                        <input type="text" id="ten-sp-nh" class="form-control" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" />
                    </div>
                    <div class="mb-3">
                        <label for="gia-sp-nh" class="form-label">Gi√° b√°n (VNƒê):</label>
                        <input type="number" id="gia-sp-nh" class="form-control" placeholder="Nh·∫≠p gi√° b√°n" min="0" />
                    </div>
                </div>

                <div class="mb-3">
                    <label for="nh-soluong" class="form-label">S·ªë l∆∞·ª£ng nh·∫≠p:</label>
                    <input type="number" id="nh-soluong" class="form-control" min="1" value="1" />
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-arrow-alt-circle-down"></i> Th√™m h√†ng nh·∫≠p</button>
            </form>
            <h3 class="mt-4">Danh s√°ch h√†ng nh·∫≠p</h3>
            <div class="table-responsive">
                <table id="table-nhaphang" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>S·ªë l∆∞·ª£ng nh·∫≠p</th>
                            <th>Ng√†y nh·∫≠p</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="tonkho" style="display:none">
            <h2><i class="fas fa-warehouse"></i> T·ªìn kho</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>S·ªë l∆∞·ª£ng t·ªìn</th>
                        </tr>
                    </thead>
                    <tbody id="tonkho-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        // --- D·ªØ li·ªáu ---
        let sanphamList = [
            { barcode: '001', ten: 'S·∫£n ph·∫©m A', gia: 100000 },
            { barcode: '002', ten: 'S·∫£n ph·∫©m B', gia: 200000 },
        ];
        let donHangHienTai = [];
        let danhSachDon = [];
        let nhapHangList = [];

        // --- Load d·ªØ li·ªáu t·ª´ localStorage ---
        function loadDuLieu() {
            const spStr = localStorage.getItem('sanphamList');
            const donStr = localStorage.getItem('danhSachDon');
            const nhStr = localStorage.getItem('nhapHangList');

            if (spStr) sanphamList = JSON.parse(spStr);
            if (donStr) danhSachDon = JSON.parse(donStr);
            if (nhStr) nhapHangList = JSON.parse(nhStr);
        }

        // --- L∆∞u d·ªØ li·ªáu v√†o localStorage ---
        function luuDuLieu() {
            localStorage.setItem('sanphamList', JSON.stringify(sanphamList));
            localStorage.setItem('danhSachDon', JSON.stringify(danhSachDon));
            localStorage.setItem('nhapHangList', JSON.stringify(nhapHangList));
            renderTonKho(); 
        }

        loadDuLieu();

        // --- H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá ---
        function formatCurrencyForDisplay(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return 'N/A';
            }
            if (amount >= 1000) {
                return (amount / 1000).toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + 'k';
            }
            return amount.toLocaleString('vi-VN');
        }

        function formatFullCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return 'N/A';
            }
            return amount.toLocaleString('vi-VN');
        }


        // --- Qu·∫£n l√Ω s·∫£n ph·∫©m ---
        const formSanPham = document.getElementById('form-sanpham');
        const inputBarcode = document.getElementById('sp-barcode');
        const inputTen = document.getElementById('sp-ten');
        const inputGia = document.getElementById('sp-gia');
        const btnXoaSP = document.getElementById('btn-xoa-sp');
        const tbodySanPham = document.querySelector('#table-sanpham tbody');
        const spSearchInput = document.getElementById('sp-search');


        let barcodeDangSua = null;

        function renderSanPham() {
            tbodySanPham.innerHTML = '';
            const searchValue = removeVietnameseTones(spSearchInput.value.toLowerCase());

            const filteredSanPhamList = sanphamList.filter(sp => {
                const barcodeMatch = sp.barcode.toLowerCase().includes(searchValue);
                const tenMatch = removeVietnameseTones(sp.ten).toLowerCase().includes(searchValue);
                return barcodeMatch || tenMatch;
            });

            filteredSanPhamList.forEach(sp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${sp.barcode}</td>
                    <td>${sp.ten}</td>
                    <td>${formatCurrencyForDisplay(sp.gia)}</td>
                `;
                tr.style.cursor = 'pointer';
                tr.addEventListener('click', () => {
                    inputBarcode.value = sp.barcode;
                    inputTen.value = sp.ten;
                    inputGia.value = sp.gia;
                    barcodeDangSua = sp.barcode; 
                    btnXoaSP.style.display = 'inline-block';
                });
                tbodySanPham.appendChild(tr);
            });
        }

        // ===== CODE ƒê√É ƒêI·ªÄU CH·ªàNH: X·ª¨ L√ù NH·∫¨P JSON (H·ªñ TR·ª¢ JSON N·ªêI LI·ªÄN) =====
        const btnProcessJson = document.getElementById('btn-process-json');
        const jsonInputData = document.getElementById('json-input-data');

        btnProcessJson.addEventListener('click', () => {
            let rawJson = jsonInputData.value.trim();
            
            if (!rawJson) {
                alert("Vui l√≤ng d√°n ƒëo·∫°n m√£ JSON v√†o √¥ tr·ªëng!");
                return;
            }

            // X√≥a kho·∫£ng tr·∫Øng th·ª´a v√† k√Ω t·ª± xu·ªëng d√≤ng
            rawJson = rawJson.replace(/\s+/g, '');

            // Bi·ªÉu th·ª©c ch√≠nh quy ƒë·ªÉ t√¨m t·∫•t c·∫£ c√°c l·∫ßn xu·∫•t hi·ªán c·ªßa JSON array b·∫Øt ƒë·∫ßu b·∫±ng [{"barcode"
            const jsonBlocks = rawJson.match(/\[{"barcode".*?\}\]/g);

            if (!jsonBlocks || jsonBlocks.length === 0) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y ƒë·ªãnh d·∫°ng JSON m·∫£ng h·ª£p l·ªá (v√≠ d·ª•: [{\"barcode\":\"...\"}]) trong d·ªØ li·ªáu.");
                return;
            }

            let countNew = 0;
            let countUpdate = 0;
            let totalProcessedItems = 0;
            let hasError = false;

            jsonBlocks.forEach((block, index) => {
                if (hasError) return;

                try {
                    const data = JSON.parse(block);
                    
                    if (!Array.isArray(data)) {
                        alert(`L·ªói kh·ªëi JSON ${index + 1}: D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng danh s√°ch (Array)!`);
                        hasError = true;
                        return;
                    }

                    data.forEach(item => {
                        totalProcessedItems++;
                        const barcode = String(item.barcode || "").trim();
                        const ten = item.ten || "Ch∆∞a c√≥ t√™n";
                        const gia = Number(item.gia) || 0;
                        const qr = item.qr || ""; 

                        if (barcode) {
                            const existingIndex = sanphamList.findIndex(sp => sp.barcode === barcode);
                            
                            if (existingIndex !== -1) {
                                // C·∫≠p nh·∫≠t s·∫£n ph·∫©m ƒë√£ c√≥
                                sanphamList[existingIndex].ten = ten;
                                sanphamList[existingIndex].gia = gia;
                                if (qr) sanphamList[existingIndex].qr = qr;
                                countUpdate++;
                            } else {
                                // Th√™m m·ªõi
                                sanphamList.push({
                                    barcode: barcode,
                                    ten: ten,
                                    gia: gia,
                                    qr: qr
                                });
                                countNew++;
                            }
                        }
                    });
                } catch (error) {
                    alert(`L·ªói c√∫ ph√°p JSON ·ªü kh·ªëi ${index + 1}. Vui l√≤ng ki·ªÉm tra l·∫°i: ${error.message}`);
                    hasError = true;
                }
            });

            if (hasError) {
                // N·∫øu c√≥ l·ªói, kh√¥ng l∆∞u v√† gi·ªØ nguy√™n tr·∫°ng th√°i
                return;
            }
            
            luuDuLieu();
            renderSanPham();
            renderTonKho();
            
            alert(`X·ª≠ l√Ω ho√†n t·∫•t ${jsonBlocks.length} kh·ªëi d·ªØ li·ªáu (${totalProcessedItems} s·∫£n ph·∫©m):\n- Th√™m m·ªõi: ${countNew}\n- C·∫≠p nh·∫≠t: ${countUpdate}`);
            
            // X√≥a √¥ nh·∫≠p v√† ƒë√≥ng collapse
            jsonInputData.value = '';
            const collapseElement = document.getElementById('json-import-section');
            const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });
            bsCollapse.hide();
        });
        // ==============================================

        // C√°c h√†m kh√°c gi·ªØ nguy√™n
        //... (c√°c h√†m kh√°c nh∆∞: inputBarcode.addEventListener, formSanPham.addEventListener, btnXoaSP.addEventListener, renderDonHang, btnLuuDon.addEventListener, renderDanhSachDon, renderNhapHang, navLinks.forEach, renderPhieu, tinhDoanhThu, tinhLoiNhuan, renderDoanhThuLoiNhuan, tinhTonKho, renderTonKho, removeVietnameseTones, inBangRawBT, btnInHoaDon.addEventListener, Kh·ªüi t·∫°o camera)
        
        inputBarcode.addEventListener('input', () => {
            const barcode = inputBarcode.value.trim();
            if (!barcode) {
                inputTen.value = '';
                inputGia.value = '';
                barcodeDangSua = null;
                btnXoaSP.style.display = 'none';
                return;
            }
            const sp = sanphamList.find(s => s.barcode === barcode);
            if (sp) {
                inputTen.value = sp.ten;
                inputGia.value = sp.gia;
                barcodeDangSua = sp.barcode;
                btnXoaSP.style.display = 'inline-block';
            } else {
                inputTen.value = '';
                inputGia.value = '';
                barcodeDangSua = null;
                btnXoaSP.style.display = 'none';
            }
        });

        spSearchInput.addEventListener('input', renderSanPham);


        formSanPham.addEventListener('submit', e => {
            e.preventDefault();
            const barcode = inputBarcode.value.trim();
            const ten = inputTen.value.trim();
            const gia = parseInt(inputGia.value);
            if (!barcode || !ten || isNaN(gia) || gia < 0) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá!');
                return;
            }

            if (barcodeDangSua === barcode) {
                const index = sanphamList.findIndex(sp => sp.barcode === barcode);
                if (index !== -1) {
                    sanphamList[index].ten = ten;
                    sanphamList[index].gia = gia;
                    alert('C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!');
                }
            } else {
                if (sanphamList.find(sp => sp.barcode === barcode)) {
                    alert('Barcode ƒë√£ t·ªìn t·∫°i, vui l√≤ng s·ª≠a ho·∫∑c nh·∫≠p barcode kh√°c!');
                    return;
                }
                sanphamList.push({ barcode, ten, gia });
                alert('Th√™m s·∫£n ph·∫©m m·ªõi th√†nh c√¥ng!');
            }
            formSanPham.reset();
            barcodeDangSua = null;
            btnXoaSP.style.display = 'none';
            renderSanPham();
            luuDuLieu();
        });

        btnXoaSP.addEventListener('click', () => {
            if (!barcodeDangSua) return;
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m barcode "${barcodeDangSua}" kh√¥ng?`)) {
                sanphamList = sanphamList.filter(sp => sp.barcode !== barcodeDangSua);
                alert('X√≥a s·∫£n ph·∫©m th√†nh c√¥ng!');
                formSanPham.reset();
                barcodeDangSua = null;
                btnXoaSP.style.display = 'none';
                renderSanPham();
                luuDuLieu();
            }
        });

        renderSanPham();

        // --- B√°n h√†ng ---
        const formBanHang = document.getElementById('form-banhang');
        const barcodeInput = document.getElementById('barcode');
        const thongTinSPDiv = document.getElementById('thongtin-sp');
        const nhapThongTinSPDiv = document.getElementById('nhap-thongtin-sp');
        const tenSPThuCongInput = document.getElementById('ten-sp-thu-cong');
        const giaSPThuCongInput = document.getElementById('gia-sp-thu-cong');
        const soluongInput = document.getElementById('soluong');
        const tbodyDonHang = document.querySelector('#table-donhang tbody');
        const tongTienEl = document.getElementById('tongtien');


        barcodeInput.addEventListener('input', () => {
            const barcode = barcodeInput.value.trim();
            if (!barcode) {
                thongTinSPDiv.textContent = '';
                nhapThongTinSPDiv.style.display = 'none';
                tenSPThuCongInput.value = '';
                giaSPThuCongInput.value = '';
                return;
            }
            const sp = sanphamList.find(sp => sp.barcode === barcode);
            if (sp) {
                thongTinSPDiv.textContent = `T√™n: ${sp.ten} | Gi√° b√°n: ${formatCurrencyForDisplay(sp.gia)} VNƒê`;
                nhapThongTinSPDiv.style.display = 'none';
                tenSPThuCongInput.value = '';
                giaSPThuCongInput.value = '';
            } else {
                thongTinSPDiv.textContent = 'S·∫£n ph·∫©m ch∆∞a c√≥ trong danh s√°ch. Vui l√≤ng nh·∫≠p th·ªß c√¥ng th√¥ng tin b√™n d∆∞·ªõi.';
                nhapThongTinSPDiv.style.display = 'block';
            }
        });

        formBanHang.addEventListener('submit', e => {
            e.preventDefault();
            const barcode = barcodeInput.value.trim();
            let soluong = parseInt(soluongInput.value);

            if (!barcode) {
                alert('Vui l√≤ng nh·∫≠p barcode!');
                return;
            }
            if (isNaN(soluong) || soluong < 1) {
                alert('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!');
                return;
            }

            let sp = sanphamList.find(sp => sp.barcode === barcode);

            if (!sp) {
                const tenThuCong = tenSPThuCongInput.value.trim();
                const giaThuCong = parseInt(giaSPThuCongInput.value);
                if (!tenThuCong) {
                    alert('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m th·ªß c√¥ng!');
                    return;
                }
                if (isNaN(giaThuCong) || giaThuCong < 0) {
                    alert('Vui l√≤ng nh·∫≠p gi√° b√°n h·ª£p l·ªá!');
                    return;
                }
                sp = { barcode, ten: tenThuCong, gia: giaThuCong };
            }

            const idx = donHangHienTai.findIndex(item => item.barcode === barcode);
            if (idx === -1) {
                donHangHienTai.push({ ...sp, soluong });
            } else {
                donHangHienTai[idx].soluong += soluong;
            }
            renderDonHang();
            formBanHang.reset();
            barcodeInput.value = ''; 
            thongTinSPDiv.textContent = ''; 
            nhapThongTinSPDiv.style.display = 'none'; 
        });

        function renderDonHang() {
            tbodyDonHang.innerHTML = '';
            let tongTien = 0;
            donHangHienTai.forEach((item, idx) => {
                const thanhTien = item.gia * item.soluong;
                tongTien += thanhTien;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.ten}</td>
                    <td>${item.barcode}</td>
                    <td>${item.soluong}</td>
                    <td>${formatCurrencyForDisplay(item.gia)}</td>
                    <td>${formatCurrencyForDisplay(thanhTien)}</td>
                    <td><button data-idx="${idx}" class="btn btn-sm btn-danger btn-xoa-don"><i class="fas fa-times-circle"></i> X√≥a</button></td>
                `;
                tbodyDonHang.appendChild(tr);
            });
            tongTienEl.textContent = formatFullCurrency(tongTien);

            document.querySelectorAll('.btn-xoa-don').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idxToRemove = parseInt(e.target.closest('button').getAttribute('data-idx'));
                    donHangHienTai.splice(idxToRemove, 1);
                    renderDonHang();
                });
            });
        }

        const btnLuuDon = document.getElementById('btn-luu-don');
        btnLuuDon.addEventListener('click', () => {
            if (donHangHienTai.length === 0) {
                alert('ƒê∆°n h√†ng tr·ªëng, kh√¥ng th·ªÉ l∆∞u!');
                return;
            }

            donHangHienTai.forEach(item => {
                const existingSp = sanphamList.find(sp => sp.barcode === item.barcode);

                if (!existingSp) {
                    sanphamList.push({
                        barcode: item.barcode,
                        ten: item.ten,
                        gia: item.gia,
                        qr: item.barcode 
                    });
                }
            });

            const maDon = `DH${Date.now()}`;
            const donMoi = {
                maDon,
                ngayBan: new Date().toLocaleString(),
                items: donHangHienTai.map(item => ({ ...item })), 
                tongTien: donHangHienTai.reduce((sum, i) => sum + i.gia * i.soluong, 0),
            };
            danhSachDon.push(donMoi);
            
            luuDuLieu(); 

            donHangHienTai = [];
            renderDonHang();
            renderTonKho();
            renderSanPham();

            alert(`L∆∞u ƒë∆°n h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: ${maDon}`);
        });

        // --- Xem l·∫°i ƒë∆°n b√°n ---
        const tbodyXemDon = document.querySelector('#table-xemdon tbody');

        function renderDanhSachDon() {
            tbodyXemDon.innerHTML = '';
            danhSachDon.forEach(don => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${don.maDon}</td>
                    <td>${don.ngayBan}</td>
                    <td>${formatFullCurrency(don.tongTien)}</td>
                    <td><button class="btn btn-sm btn-primary btn-xem-chi-tiet" data-madon="${don.maDon}"><i class="fas fa-eye"></i> Xem</button></td>
                `;
                tbodyXemDon.appendChild(tr);
            });

            document.querySelectorAll('.btn-xem-chi-tiet').forEach(btn => {
                btn.addEventListener('click', e => {
                    const maDon = e.target.closest('button').getAttribute('data-madon');
                    const don = danhSachDon.find(d => d.maDon === maDon);
                    if (don) {
                        let chiTietHTML = `Chi ti·∫øt ƒë∆°n h√†ng: ${don.maDon}\nNg√†y b√°n: ${don.ngayBan}\n\n`;
                        don.items.forEach(item => {
                            chiTietHTML += `- ${item.ten} | Barcode: ${item.barcode} | SL: ${item.soluong} | Gi√°: ${formatCurrencyForDisplay(item.gia)} | Th√†nh ti·ªÅn: ${formatCurrencyForDisplay(item.gia * item.soluong)}\n`;
                        });
                        chiTietHTML += `\nT·ªïng ti·ªÅn: ${formatFullCurrency(don.tongTien)} VNƒê`;
                        alert(chiTietHTML);
                    }
                });
            });
        }

        // --- Qu·∫£n l√Ω h√†ng nh·∫≠p ---
        const formNhapHang = document.getElementById('form-nhaphang');
        const nhBarcodeInput = document.getElementById('nh-barcode');
        const tenSPNhapInput = document.getElementById('ten-sp-nh');
        const giaSPNhapInput = document.getElementById('gia-sp-nh');
        const nhapThongTinSPNhapDiv = document.getElementById('nhap-thongtin-sp-nh');
        const nhSoLuongInput = document.getElementById('nh-soluong');
        const tbodyNhapHang = document.querySelector('#table-nhaphang tbody');

        nhBarcodeInput.addEventListener('input', () => {
            const barcode = nhBarcodeInput.value.trim();
            if (!barcode) {
                nhapThongTinSPNhapDiv.style.display = 'none';
                tenSPNhapInput.value = '';
                giaSPNhapInput.value = '';
                return;
            }
            const sp = sanphamList.find(sp => sp.barcode === barcode);
            if (sp) {
                nhapThongTinSPNhapDiv.style.display = 'none';
                tenSPNhapInput.value = sp.ten; 
                giaSPNhapInput.value = sp.gia;
            } else {
                nhapThongTinSPNhapDiv.style.display = 'block';
                tenSPNhapInput.value = ''; 
                giaSPNhapInput.value = ''; 
            }
        });

        formNhapHang.addEventListener('submit', e => {
            e.preventDefault();

            const barcode = nhBarcodeInput.value.trim();
            const soluong = parseInt(nhSoLuongInput.value);

            if (!barcode) {
                alert('Vui l√≤ng nh·∫≠p barcode s·∫£n ph·∫©m!');
                return;
            }
            if (isNaN(soluong) || soluong < 1) {
                alert('S·ªë l∆∞·ª£ng nh·∫≠p ph·∫£i l·ªõn h∆°n 0!');
                return;
            }

            let sp = sanphamList.find(sp => sp.barcode === barcode);

            if (!sp) {
                const tenThuCong = tenSPNhapInput.value.trim();
                const giaThuCong = parseInt(giaSPNhapInput.value);

                if (!tenThuCong) {
                    alert('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m th·ªß c√¥ng!');
                    return;
                }
                if (isNaN(giaThuCong) || giaThuCong < 0) {
                    alert('Vui l√≤ng nh·∫≠p gi√° b√°n h·ª£p l·ªá!');
                    return;
                }
                sp = { barcode, ten: tenThuCong, gia: giaThuCong };
                sanphamList.push(sp);
                renderSanPham();
            }

            nhapHangList.push({
                barcode,
                ten: sp.ten,
                soluong,
                ngayNhap: new Date().toLocaleString(),
            });

            luuDuLieu();
            renderNhapHang();

            formNhapHang.reset();
            nhapThongTinSPNhapDiv.style.display = 'none';
            tenSPNhapInput.value = '';
            giaSPNhapInput.value = '';
            nhBarcodeInput.value = '';

            alert('Th√™m h√†ng nh·∫≠p th√†nh c√¥ng!');
        });

        function renderNhapHang() {
            tbodyNhapHang.innerHTML = '';
            nhapHangList.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.barcode}</td>
                    <td>${item.ten}</td>
                    <td>${item.soluong}</td>
                    <td>${item.ngayNhap}</td>
                `;
                tbodyNhapHang.appendChild(tr);
            });
        }

        // --- Chuy·ªÉn tab ---
        const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
        const sections = document.querySelectorAll('main section');

        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();

                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                const sectionId = link.getAttribute('data-section');

                sections.forEach(sec => {
                    if (sec.id === sectionId) {
                        sec.style.display = 'block';

                        if (sectionId === 'xemdon') renderDanhSachDon();
                        if (sectionId === 'nhaphang') renderNhapHang();
                        if (sectionId === 'phieu') renderPhieu();
                        if (sectionId === 'doanhthu') renderDoanhThuLoiNhuan();
                        if (sectionId === 'tonkho') renderTonKho();
                        if (sectionId === 'banhang') renderDonHang();
                        if (sectionId === 'sanpham') renderSanPham();
                    } else {
                        sec.style.display = 'none';
                    }
                });
            });
        });

        // --- Qu·∫£n l√Ω phi·∫øu n√¢ng cao ---
        const tbodyPhieuTable = document.querySelector('#table-phieu tbody');

        function renderPhieu() {
            tbodyPhieuTable.innerHTML = '';
            danhSachDon.forEach((don, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${don.maDon}</td>
                    <td>${don.ngayBan}</td>
                    <td>${formatFullCurrency(don.tongTien)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-xem-phieu me-2" data-idx="${idx}"><i class="fas fa-eye"></i> Xem</button>
                        <button class="btn btn-sm btn-danger btn-xoa-phieu" data-idx="${idx}"><i class="fas fa-trash-alt"></i> X√≥a</button>
                    </td>
                `;
                tbodyPhieuTable.appendChild(tr);
            });

            document.querySelectorAll('.btn-xem-phieu').forEach(btn => {
                btn.addEventListener('click', e => {
                    const idx = parseInt(e.target.closest('button').getAttribute('data-idx'));
                    if (!isNaN(idx)) {
                        const don = danhSachDon[idx];
                        if (don) {
                            let chiTiet = `Chi ti·∫øt ƒë∆°n h√†ng: ${don.maDon}\nNg√†y b√°n: ${don.ngayBan}\n\n`;
                            don.items.forEach(item => {
                                chiTiet += `- ${item.ten} | Barcode: ${item.barcode} | SL: ${item.soluong} | Gi√°: ${formatCurrencyForDisplay(item.gia)} | Th√†nh ti·ªÅn: ${formatCurrencyForDisplay(item.gia * item.soluong)}\n`;
                            });
                            chiTiet += `\nT·ªïng ti·ªÅn: ${formatFullCurrency(don.tongTien)} VNƒê`;
                            alert(chiTiet);
                        }
                    }
                });
            });

            document.querySelectorAll('.btn-xoa-phieu').forEach(btn => {
                btn.addEventListener('click', e => {
                    const idx = parseInt(e.target.closest('button').getAttribute('data-idx'));
                    if (!isNaN(idx)) {
                        if (confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a phi·∫øu ${danhSachDon[idx].maDon} ?`)) {
                            danhSachDon.splice(idx, 1);
                            luuDuLieu();
                            renderPhieu();
                            renderDanhSachDon(); 
                            renderDoanhThuLoiNhuan(); 
                            renderTonKho(); 
                            alert('ƒê√£ x√≥a phi·∫øu th√†nh c√¥ng!');
                        }
                    }
                });
            });
        }

        // --- Doanh thu - L·ª£i nhu·∫≠n ---
        function tinhDoanhThu() {
            return danhSachDon.reduce((sum, don) => sum + don.tongTien, 0);
        }

        function tinhLoiNhuan() {
            const giaNhapTB = {};
            const tongSLNhap = {};
            nhapHangList.forEach(nh => {
                if (!giaNhapTB[nh.barcode]) {
                    giaNhapTB[nh.barcode] = 0;
                    tongSLNhap[nh.barcode] = 0;
                }
                const sp = sanphamList.find(s => s.barcode === nh.barcode);
                const giaNhap = sp ? sp.gia : 0; 
                giaNhapTB[nh.barcode] = (giaNhapTB[nh.barcode] * tongSLNhap[nh.barcode] + nh.soluong * giaNhap) / (tongSLNhap[nh.barcode] + nh.soluong);
                tongSLNhap[nh.barcode] += nh.soluong;
            });

            let tongGiaVon = 0;
            danhSachDon.forEach(don => {
                don.items.forEach(item => {
                    const avgNhap = giaNhapTB[item.barcode] || 0;
                    tongGiaVon += item.soluong * avgNhap;
                });
            });

            return tinhDoanhThu() - tongGiaVon;
        }

        function renderDoanhThuLoiNhuan() {
            document.getElementById('tong-doanh-thu').textContent = formatFullCurrency(tinhDoanhThu());
            document.getElementById('loi-nhuan').textContent = formatFullCurrency(tinhLoiNhuan());
        }

        function tinhTonKho() {
            const tonkho = {};
            sanphamList.forEach(sp => {
                tonkho[sp.barcode] = 0; 
            });

            nhapHangList.forEach(e => {
                if (!tonkho[e.barcode]) tonkho[e.barcode] = 0;
                tonkho[e.barcode] += e.soluong;
            });

            danhSachDon.forEach(don => {
                don.items.forEach(item => {
                    if (!tonkho[item.barcode]) tonkho[item.barcode] = 0; 
                    tonkho[item.barcode] -= item.soluong;
                });
            });
            return tonkho;
        }

        function renderTonKho() {
            const tbody = document.getElementById("tonkho-body");
            tbody.innerHTML = "";
            const tonkhoData = tinhTonKho();

            sanphamList.forEach(sp => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${sp.barcode}</td>
                    <td>${sp.ten}</td>
                    <td>${tonkhoData[sp.barcode] || 0}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removeVietnameseTones(str) {
            return str
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/ƒë/g, "d")
                .replace(/ƒê/g, "D");
        }

        function inBangRawBT(hoaDonText) {
            const encodedText = encodeURIComponent(hoaDonText);
            const url = `rawbt://print?text=${encodedText}`;
            window.location.href = url;
        }

        const btnInHoaDon = document.getElementById('btn-in-hoa-don');

        btnInHoaDon.addEventListener('click', () => {
            if (donHangHienTai.length === 0) {
                alert('ƒê∆°n h√†ng tr·ªëng, kh√¥ng th·ªÉ in!');
                return;
            }

            let hoaDonText = `CUA HANG DUNG THANH\n--------------------------------\n`;
            hoaDonText += `Ngay: ${new Date().toLocaleString()}\n--------------------------------\n`;
            hoaDonText += `Ten SP      SL   Gia  Thanh tien\n`;
            hoaDonText += `--------------------------------\n`; 

            donHangHienTai.forEach(item => {
                const thanhTien = item.gia * item.soluong;
                const tenSP = removeVietnameseTones(item.ten).substring(0, 12).padEnd(12, ' ');
                const sl = item.soluong.toString().padStart(3, ' ');
                const gia = formatCurrencyForDisplay(item.gia).padStart(6, ' '); 
                const thanhTienStr = formatCurrencyForDisplay(thanhTien).padStart(8, ' '); 

                hoaDonText += `${tenSP} ${sl} ${gia} ${thanhTienStr}\n`;
            });

            const tongTien = donHangHienTai.reduce((sum, i) => sum + i.gia * i.soluong, 0);
            hoaDonText += `--------------------------------\n`;
            
            const tongTienFormatted = formatFullCurrency(tongTien) + ' VND'; 
            const tongCongPrefix = `TONG CONG: `;
            const maxLineLength = 32; 
            const paddingLength = maxLineLength - tongCongPrefix.length - tongTienFormatted.length;
            const padding = ' '.repeat(Math.max(0, paddingLength)); 

            hoaDonText += `${tongCongPrefix}${padding}${tongTienFormatted}\n`;

            hoaDonText += `--------------------------------\nCAM ON QUY KHACH!\n\n\n\n`;

            inBangRawBT(hoaDonText);
        });


        // Kh·ªüi t·∫°o camera barcode cho B√°n h√†ng
        document.getElementById('btn-mo-camera').addEventListener('click', () => {
            const cameraArea = document.getElementById('camera-area');
            cameraArea.style.display = 'block';

            const html5QrCode = new Html5Qrcode("camera-area");
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    document.getElementById('barcode').value = decodedText;
                    html5QrCode.stop();
                    cameraArea.style.display = 'none';
                    document.getElementById('barcode').dispatchEvent(new Event('input'));
                },
                (errorMessage) => {
                    console.error("L·ªói khi qu√©t barcode (B√°n h√†ng):", errorMessage);
                }
            ).catch(err => {
                console.error("Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau (B√°n h√†ng):", err);
                alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p ho·∫∑c thi·∫øt b·ªã.");
            });
        });

        // Kh·ªüi t·∫°o camera barcode cho S·∫£n ph·∫©m
        document.getElementById('btn-mo-camera-sp').addEventListener('click', () => {
            const cameraAreaSp = document.getElementById('camera-area-sp');
            cameraAreaSp.style.display = 'block';

            const html5QrCodeSp = new Html5Qrcode("camera-area-sp");
            html5QrCodeSp.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    document.getElementById('sp-barcode').value = decodedText;
                    html5QrCodeSp.stop();
                    cameraAreaSp.style.display = 'none';
                    document.getElementById('sp-barcode').dispatchEvent(new Event('input'));
                },
                (errorMessage) => {
                    console.error("L·ªói khi qu√©t barcode (S·∫£n ph·∫©m):", errorMessage);
                }
            ).catch(err => {
                console.error("Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau (S·∫£n ph·∫©m):", err);
                alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau cho S·∫£n ph·∫©m. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p ho·∫∑c thi·∫øt b·ªã.");
            });
        });

        // Kh·ªüi t·∫°o camera barcode cho Nh·∫≠p h√†ng
        document.getElementById('btn-mo-camera-nh').addEventListener('click', () => {
            const cameraAreaNh = document.getElementById('camera-area-nh');
            cameraAreaNh.style.display = 'block';

            const html5QrCodeNh = new Html5Qrcode("camera-area-nh");
            html5QrCodeNh.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    document.getElementById('nh-barcode').value = decodedText;
                    html5QrCodeNh.stop();
                    cameraAreaNh.style.display = 'none';
                    document.getElementById('nh-barcode').dispatchEvent(new Event('input'));
                },
                (errorMessage) => {
                    console.error("L·ªói khi qu√©t barcode (Nh·∫≠p h√†ng):", errorMessage);
                }
            ).catch(err => {
                console.error("Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau (Nh·∫≠p h√†ng):", err);
                alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau cho Nh·∫≠p h√†ng. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p ho·∫∑c thi·∫øt b·ªã.");
            });
        });


        // Khi load d·ªØ li·ªáu ban ƒë·∫ßu
        document.addEventListener('DOMContentLoaded', () => {
            loadDuLieu();
            renderSanPham();
            renderDonHang();
            renderDanhSachDon();
            renderNhapHang();
            renderPhieu();
            renderDoanhThuLoiNhuan();
            renderTonKho();
        });
    </script>

</body>
</html>