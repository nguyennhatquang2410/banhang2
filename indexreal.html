<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bán Hàng & Quản Lý Kho - By Quang dz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9eff5; color: #343a40; }
        .navbar { background-color: #17a2b8; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); padding: 10px 0; }
        .navbar-brand { font-weight: 700; font-size: 1.5em; }
        .navbar-nav .nav-link { color: white; padding: 12px 20px; font-weight: 600; border-radius: 8px; transition: background-color 0.3s ease, color 0.3s ease; }
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active { background-color: #138496; color: white; }
        main { padding: 25px 0; }
        section { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 25px; display: none; }
        h2, h3 { color: #007bff; margin-bottom: 25px; border-bottom: 2px solid #e0e6ea; padding-bottom: 12px; }
        .form-control { border-radius: 6px; border: 1px solid #cdd4da; padding: 12px; }
        .btn { border-radius: 6px; padding: 12px 25px; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary { background-color: #007bff; border-color: #007bff; }
        .btn-success { background-color: #28a745; border-color: #28a745; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; }
        table { margin-top: 25px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th { background-color: #007bff; color: white; font-weight: 700; }
        tbody tr { cursor: pointer; }
        #tongtien { font-size: 2.2em; font-weight: bold; color: #dc3545; text-align: right; display: block; margin-top: 25px; padding-top: 15px; border-top: 1px dashed #ced4da; }
        .camera-area, #camera-area, #camera-area-sp, #camera-area-nh, #camera-area-xh { width: 100%; max-width: 450px; margin: 20px auto; border: 3px solid #007bff; border-radius: 10px; overflow: hidden; background-color: #f8f9fa; display: none; }
        #phieu-xuat-area { border: 2px dashed #333; padding: 20px; background: #fff; margin-top: 20px; border-radius: 8px; }
        .phieu-header { text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        @media print { .navbar, form, button, .table-responsive, h2 { display: none !important; } #phieu-xuat-area { display: block !important; border: none; } }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">QUẢN LÝ TỔNG HỢP</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" data-section="banhang" href="#"><i class="fas fa-cash-register"></i> Bán hàng</a></li>
                    <li class="nav-item"><a class="nav-link" data-section="nhaphang" href="#"><i class="fas fa-download"></i> Nhập kho</a></li>
                    <li class="nav-item"><a class="nav-link" data-section="xuathang" href="#"><i class="fas fa-upload"></i> Xuất kho</a></li>
                    <li class="nav-item"><a class="nav-link" data-section="xemdon" href="#"><i class="fas fa-list-alt"></i> Xem đơn</a></li>
                    <li class="nav-item"><a class="nav-link" data-section="doanhthu" href="#"><i class="fas fa-chart-line"></i> Doanh thu</a></li>
                    <li class="nav-item"><a class="nav-link" data-section="sanpham" href="#"><i class="fas fa-box"></i> Sản phẩm</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <section id="banhang" style="display: block;">
            <h2><i class="fas fa-cash-register"></i> Bán hàng</h2>
            <form id="form-banhang">
                <div class="mb-3">
                    <label for="barcode" class="form-label">Mã barcode:</label>
                    <input type="text" id="barcode" class="form-control" required autocomplete="off" placeholder="Nhập barcode hoặc quét" />
                    <button type="button" id="btn-mo-camera" class="btn btn-info mt-2 text-white"><i class="fas fa-qrcode"></i> Quét barcode</button>
                    <div id="camera-area"></div>
                    <div id="thongtin-sp" class="mt-2"></div>
                    <div id="nhap-thongtin-sp" style="display:none;" class="mt-3 p-3 bg-warning-subtle border border-warning rounded">
                        <p class="mb-2 text-danger">Sản phẩm mới chưa có trong danh mục. Nhập nhanh:</p>
                        <div class="mb-3"><label class="form-label">Tên SP:</label><input type="text" id="ten-sp-thu-cong" class="form-control" /></div>
                        <div class="mb-3"><label class="form-label">Giá bán:</label><input type="number" id="gia-sp-thu-cong" class="form-control" /></div>
                    </div>
                </div>
                <div class="mb-3"><label for="soluong" class="form-label">Số lượng:</label><input type="number" id="soluong" class="form-control" value="1" min="1" required /></div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Thêm vào đơn</button>
            </form>
            <h3 class="mt-4">Đơn hàng hiện tại</h3>
            <div class="table-responsive"><table id="table-donhang" class="table table-striped table-hover"><thead><tr><th>Tên SP</th><th>Barcode</th><th>SL</th><th>Giá</th><th>Thành tiền</th><th>Xóa</th></tr></thead><tbody></tbody></table></div>
            <h3 class="mt-3">Tổng tiền: <span id="tongtien">0</span> VNĐ</h3>
            <div class="d-grid gap-2 d-md-block mt-3">
                <button id="btn-luu-don" class="btn btn-success"><i class="fas fa-save"></i> Lưu đơn hàng</button>
                <button id="btn-in-hoa-don" class="btn btn-info text-white"><i class="fas fa-print"></i> In hóa đơn (RawBT)</button>
            </div>
        </section>

        <section id="nhaphang">
            <h2><i class="fas fa-truck-loading"></i> Nhập kho & Tồn kho</h2>
            <form id="form-nhaphang">
                <div class="mb-3">
                    <label class="form-label fw-bold">Barcode:</label>
                    <div class="input-group">
                        <input type="text" id="nh-barcode" class="form-control" placeholder="Quét hoặc nhập mã">
                        <button type="button" id="btn-mo-camera-nh" class="btn btn-info text-white"><i class="fas fa-qrcode"></i></button>
                    </div>
                    <div id="camera-area-nh" class="camera-area"></div>
                </div>
                <div id="nhap-thongtin-sp-nh" style="display:none;" class="mt-3 p-3 bg-info-subtle border border-info rounded">
                    <div class="mb-3"><label class="form-label">Tên SP:</label><input type="text" id="ten-sp-nh" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Giá nhập:</label><input type="number" id="gia-nhap-nh" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Quy đổi (Thùng/Chai):</label>
                        <div class="d-flex gap-2">
                            <input type="text" id="dv-lon" class="form-control" placeholder="Thùng">
                            <input type="text" id="dv-nho" class="form-control" placeholder="Vd: 24 chai">
                        </div>
                    </div>
                </div>
                <div class="mb-3"><label class="form-label fw-bold">Số lượng nhập:</label><input type="number" id="nh-soluong" class="form-control" value="1"></div>
                <div class="d-grid gap-2">
                    <button type="submit" id="btn-submit-nh" class="btn btn-primary">Xác nhận nhập kho</button>
                    <button type="button" id="btn-xoa-nh" class="btn btn-danger" style="display:none;">Xóa mặt hàng</button>
                    <button type="button" id="btn-huy-nh" class="btn btn-secondary" style="display:none;">Hủy</button>
                    <button type="button" id="btn-excel-nh" class="btn btn-success"><i class="fas fa-file-excel"></i> Xuất Excel Tồn Kho</button>
                </div>
            </form>
            <div class="table-responsive mt-4">
                <table id="table-nhaphang" class="table table-striped table-hover">
                    <thead><tr><th>Barcode</th><th>Tên SP</th><th>Giá nhập</th><th>Tồn</th><th>Đã xuất</th><th>Đơn vị</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="xuathang">
            <h2><i class="fas fa-box-open"></i> Xuất hàng tạo phiếu</h2>
            <form id="form-xuathang">
                <div class="mb-3">
                    <label class="form-label fw-bold">Quét mã xuất:</label>
                    <div class="input-group">
                        <input type="text" id="xh-barcode" class="form-control border-danger" placeholder="Nhập mã...">
                        <button type="button" id="btn-mo-camera-xh" class="btn btn-danger"><i class="fas fa-qrcode"></i></button>
                    </div>
                    <div id="camera-area-xh" class="camera-area"></div>
                </div>
                <div id="nhap-thongtin-sp-xh" style="display:none;" class="mt-3 p-3 bg-danger-subtle border border-danger rounded">
                    <div class="mb-3"><label class="form-label">Tên SP:</label><input type="text" id="ten-sp-xh" class="form-control"></div>
                </div>
                <div class="mb-3"><label class="form-label fw-bold">Số lượng xuất:</label><input type="number" id="xh-soluong" class="form-control border-danger" value="1"></div>
                <button type="submit" class="btn btn-danger w-100">Thêm vào phiếu tạm</button>
            </form>
            <div class="table-responsive mt-3"><table class="table table-bordered"><thead class="table-dark"><tr><th>Tên SP</th><th>SL</th></tr></thead><tbody id="list-xuat-tam"></tbody></table></div>
            <button id="btn-luu-xuat" class="btn btn-dark w-100 mt-2">LƯU & HIỆN PHIẾU XUẤT</button>
            <div id="area-phieu-hien-thi" style="display:none;">
                <div id="phieu-xuat-area">
                    <div class="phieu-header"><h3>PHIẾU XUẤT HÀNG</h3><p id="phieu-thoigian"></p></div>
                    <table class="table table-sm table-bordered"><thead><tr><th>Sản phẩm</th><th>SL</th></tr></thead><tbody id="phieu-noi-dung"></tbody></table>
                </div>
                <button onclick="window.print()" class="btn btn-outline-primary w-100 mt-2">In Phiếu</button>
            </div>
        </section>

        <section id="xemdon">
            <h2><i class="fas fa-list-alt"></i> Danh sách đơn bán</h2>
            <div class="table-responsive"><table id="table-xemdon" class="table table-striped table-hover"><thead><tr><th>Mã đơn</th><th>Ngày</th><th>Tổng tiền</th></tr></thead><tbody></tbody></table></div>
        </section>

        <section id="doanhthu">
            <h2><i class="fas fa-chart-line"></i> Báo cáo doanh thu</h2>
            <p><strong>Tổng doanh thu bán hàng:</strong> <span id="tong-doanh-thu" class="text-danger fw-bold">0</span> VNĐ</p>
        </section>

        <section id="sanpham">
            <h2><i class="fas fa-box"></i> Danh mục sản phẩm bán lẻ</h2>
            <form id="form-sanpham">
                <div class="mb-3">
                    <label class="form-label">Barcode:</label>
                    <div class="input-group">
                        <input type="text" id="sp-barcode" class="form-control" placeholder="Barcode..." />
                        <button type="button" id="btn-mo-camera-sp" class="btn btn-info text-white"><i class="fas fa-qrcode"></i></button>
                    </div>
                    <div id="camera-area-sp"></div>
                </div>
                <div class="mb-3"><label class="form-label">Tên sản phẩm:</label><input type="text" id="sp-ten" class="form-control" required /></div>
                <div class="mb-3"><label class="form-label">Giá bán:</label><input type="number" id="sp-gia" class="form-control" required /></div>
                <div class="d-grid gap-2 d-md-block">
                    <button type="submit" id="btn-submit-sp" class="btn btn-primary">Lưu sản phẩm</button>
                    <button type="button" id="btn-xoa-sp" class="btn btn-danger" style="display: none;">Xóa sản phẩm</button>
                    <button type="button" id="btn-huy-sp" class="btn btn-secondary" style="display: none;">Hủy</button>
                </div>
            </form>
            <div class="mt-4"><input type="text" id="sp-search" class="form-control" placeholder="Tìm kiếm nhanh..." /></div>
            <div class="table-responsive"><table id="table-sanpham" class="table table-striped table-hover"><thead><tr><th>Barcode</th><th>Tên sản phẩm</th><th>Giá bán</th></tr></thead><tbody></tbody></table></div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        // --- DỮ LIỆU ---
        let sanphamList = JSON.parse(localStorage.getItem('sanphamList')) || [];
        let danhSachDon = JSON.parse(localStorage.getItem('danhSachDon')) || [];
        let nhapHangList = JSON.parse(localStorage.getItem('nhapHangList')) || [];
        let donHangHienTai = [];

        function luuMoiThu() {
            localStorage.setItem('sanphamList', JSON.stringify(sanphamList));
            localStorage.setItem('danhSachDon', JSON.stringify(danhSachDon));
            localStorage.setItem('nhapHangList', JSON.stringify(nhapHangList));
        }

        function formatCurrency(n) { return Number(n).toLocaleString('vi-VN'); }

        // --- ĐIỀU HƯỚNG TAB (KHÔNG TẢI LẠI TRANG) ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.onclick = e => {
                e.preventDefault();
                showSection(link.dataset.section);
            };
        });

        function showSection(id) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-section="${id}"]`).classList.add('active');
            document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            
            if(id === 'sanpham') renderSanPham();
            if(id === 'nhaphang') renderNH();
            if(id === 'xemdon') renderDanhSachDon();
            if(id === 'doanhthu') renderDoanhThu();
        }

        // --- QUẢN LÝ SẢN PHẨM ---
        const formSP = document.getElementById('form-sanpham');
        formSP.onsubmit = e => {
            e.preventDefault();
            const bc = document.getElementById('sp-barcode').value.trim();
            const ten = document.getElementById('sp-ten').value.trim();
            const gia = parseInt(document.getElementById('sp-gia').value);
            const isEditing = document.getElementById('sp-barcode').readOnly;

            if(isEditing) {
                const idx = sanphamList.findIndex(s => s.barcode === bc);
                if(idx > -1) sanphamList[idx] = { barcode: bc, ten, gia };
            } else {
                if(sanphamList.find(s => s.barcode === bc)) return alert("Mã đã tồn tại!");
                sanphamList.push({ barcode: bc, ten, gia });
            }
            luuMoiThu(); renderSanPham(); resetFormSP();
        };

        function renderSanPham() {
            const search = document.getElementById('sp-search').value.toLowerCase();
            const tbody = document.querySelector('#table-sanpham tbody');
            tbody.innerHTML = '';
            sanphamList.filter(s => s.ten.toLowerCase().includes(search) || s.barcode.includes(search)).forEach(sp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${sp.barcode}</td><td>${sp.ten}</td><td>${formatCurrency(sp.gia)}</td>`;
                tr.onclick = () => editSP(sp.barcode);
                tbody.appendChild(tr);
            });
        }

        function editSP(bc) {
            const sp = sanphamList.find(s => s.barcode === bc);
            document.getElementById('sp-barcode').value = sp.barcode;
            document.getElementById('sp-barcode').readOnly = true;
            document.getElementById('sp-ten').value = sp.ten;
            document.getElementById('sp-gia').value = sp.gia;
            document.getElementById('btn-submit-sp').innerText = "Cập nhật";
            document.getElementById('btn-xoa-sp', 'btn-huy-sp').forEach(b => document.getElementById(b).style.display='inline-block');
        }

        function resetFormSP() {
            formSP.reset();
            document.getElementById('sp-barcode').readOnly = false;
            document.getElementById('btn-submit-sp').innerText = "Lưu sản phẩm";
            document.getElementById('btn-xoa-sp').style.display = 'none';
            document.getElementById('btn-huy-sp').style.display = 'none';
        }

        // --- QUẢN LÝ NHẬP HÀNG (SỬA LỖI TẠI ĐÂY) ---
        const bcNH = document.getElementById('nh-barcode');
        bcNH.oninput = () => {
            const sp = nhapHangList.find(s => s.barcode === bcNH.value.trim());
            const area = document.getElementById('nhap-thongtin-sp-nh');
            if(sp) {
                area.style.display = 'block';
                document.getElementById('ten-sp-nh').value = sp.ten;
                document.getElementById('gia-nhap-nh').value = sp.giaNhap;
                document.getElementById('dv-lon').value = sp.dvLon;
                document.getElementById('dv-nho').value = sp.dvNho;
            } else {
                area.style.display = 'block';
                document.getElementById('ten-sp-nh').value = '';
                document.getElementById('gia-nhap-nh').value = '';
            }
        };

        document.getElementById('form-nhaphang').onsubmit = e => {
            e.preventDefault();
            const bc = bcNH.value.trim();
            const sl = parseInt(document.getElementById('nh-soluong').value);
            const ten = document.getElementById('ten-sp-nh').value;
            const gia = parseInt(document.getElementById('gia-nhap-nh').value);

            let sp = nhapHangList.find(s => s.barcode === bc);
            if(sp) {
                sp.ton += sl;
                sp.ten = ten;
                sp.giaNhap = gia;
                sp.dvLon = document.getElementById('dv-lon').value;
                sp.dvNho = document.getElementById('dv-nho').value;
            } else {
                nhapHangList.push({
                    barcode: bc, ten, giaNhap: gia, ton: sl, daXuat: 0,
                    dvLon: document.getElementById('dv-lon').value,
                    dvNho: document.getElementById('dv-nho').value
                });
            }
            luuMoiThu();
            renderNH();
            e.target.reset();
            document.getElementById('nhap-thongtin-sp-nh').style.display = 'none';
            alert("Đã nhập kho thành công!");
        };

        function renderNH() {
            const tbody = document.querySelector('#table-nhaphang tbody');
            tbody.innerHTML = '';
            nhapHangList.forEach(nh => {
                tbody.innerHTML += `<tr><td>${nh.barcode}</td><td>${nh.ten}</td><td>${formatCurrency(nh.giaNhap)}</td><td>${nh.ton}</td><td>${nh.daXuat}</td><td>${nh.dvLon}/${nh.dvNho}</td></tr>`;
            });
        }

        // --- BÁN HÀNG ---
        const bcInput = document.getElementById('barcode');
        bcInput.oninput = () => {
            const sp = sanphamList.find(s => s.barcode === bcInput.value.trim());
            const info = document.getElementById('thongtin-sp');
            const manual = document.getElementById('nhap-thongtin-sp');
            if(sp) { info.textContent = `SP: ${sp.ten} - Giá: ${formatCurrency(sp.gia)}`; manual.style.display='none'; }
            else if(bcInput.value) { info.textContent = "Mã mới:"; manual.style.display='block'; }
        };

        document.getElementById('form-banhang').onsubmit = e => {
            e.preventDefault();
            const bc = bcInput.value.trim();
            const sl = parseInt(document.getElementById('soluong').value);
            let sp = sanphamList.find(s => s.barcode === bc);
            if(!sp) {
                const ten = document.getElementById('ten-sp-thu-cong').value;
                const gia = parseInt(document.getElementById('gia-sp-thu-cong').value);
                if(!ten || !gia) return alert("Nhập đủ tên và giá!");
                sp = { barcode: bc, ten, gia };
                sanphamList.push(sp);
            }
            const idx = donHangHienTai.findIndex(i => i.barcode === bc);
            if(idx > -1) donHangHienTai[idx].soluong += sl;
            else donHangHienTai.push({...sp, soluong: sl});
            renderDonHang();
            e.target.reset();
            document.getElementById('nhap-thongtin-sp').style.display='none';
            document.getElementById('thongtin-sp').textContent = '';
        };

        function renderDonHang() {
            const tbody = document.querySelector('#table-donhang tbody');
            tbody.innerHTML = ''; let tong = 0;
            donHangHienTai.forEach((item, i) => {
                const tt = item.gia * item.soluong; tong += tt;
                tbody.innerHTML += `<tr><td>${item.ten}</td><td>${item.barcode}</td><td>${item.soluong}</td><td>${formatCurrency(item.gia)}</td><td>${formatCurrency(tt)}</td><td><button class="btn btn-sm btn-danger" onclick="donHangHienTai.splice(${i},1);renderDonHang()">Xóa</button></td></tr>`;
            });
            document.getElementById('tongtien').textContent = formatCurrency(tong);
        }

        document.getElementById('btn-luu-don').onclick = () => {
            if(!donHangHienTai.length) return;
            const don = { maDon: "HD"+Date.now(), ngayBan: new Date().toLocaleString(), items: [...donHangHienTai], tongTien: donHangHienTai.reduce((s,i)=>s+(i.gia*i.soluong),0) };
            danhSachDon.push(don);
            luuMoiThu(); donHangHienTai=[]; renderDonHang();
            alert("Đã lưu đơn hàng!");
        };

        // --- CAMERA ---
        function startCam(btn, input, area) {
            document.getElementById(btn).onclick = () => {
                const dom = document.getElementById(area); dom.style.display='block';
                const scanner = new Html5Qrcode(area);
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                    document.getElementById(input).value = txt;
                    document.getElementById(input).dispatchEvent(new Event('input'));
                    scanner.stop(); dom.style.display='none';
                }).catch(err => console.error(err));
            };
        }
        startCam('btn-mo-camera','barcode','camera-area');
        startCam('btn-mo-camera-sp','sp-barcode','camera-area-sp');
        startCam('btn-mo-camera-nh','nh-barcode','camera-area-nh');
        startCam('btn-mo-camera-xh','xh-barcode','camera-area-xh');

        // --- DOANH THU & XEM ĐƠN ---
        function renderDanhSachDon() {
            const tbody = document.querySelector('#table-xemdon tbody');
            tbody.innerHTML = '';
            danhSachDon.forEach(d => {
                tbody.innerHTML += `<tr><td>${d.maDon}</td><td>${d.ngayBan}</td><td>${formatCurrency(d.tongTien)}</td></tr>`;
            });
        }
        function renderDoanhThu() {
            document.getElementById('tong-doanh-thu').innerText = formatCurrency(danhSachDon.reduce((s, d) => s + d.tongTien, 0));
        }

        renderSanPham();
    </script>
</body>
</html>